(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{419:function(a,t,s){"use strict";s.r(t);var r=s(25),e=Object(r.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"nat网络地址转发例子"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nat网络地址转发例子"}},[a._v("#")]),a._v(" NAT网络地址转发例子")]),a._v(" "),t("h2",{attrs:{id:"_1-网络情况"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-网络情况"}},[a._v("#")]),a._v(" 1. 网络情况")]),a._v(" "),t("p",[a._v("有三台主机A、B、C， 我们把A和B组成一个子网，B和C组成一个子网，这样B就是两个子网的交集。")]),a._v(" "),t("table",[t("thead",[t("tr",[t("th",[a._v("主机")]),a._v(" "),t("th",[a._v("ip")])])]),a._v(" "),t("tbody",[t("tr",[t("td",[a._v("主机A")]),a._v(" "),t("td",[a._v("192.168.1.100/24")])]),a._v(" "),t("tr",[t("td",[a._v("主机B")]),a._v(" "),t("td",[a._v("192.168.1.1/24, 172.16.1.101/24")])]),a._v(" "),t("tr",[t("td",[a._v("主机C")]),a._v(" "),t("td",[a._v("172.16.1.100/24")])])])]),a._v(" "),t("p",[a._v("这样的网络场景，A和B可以通信，B和C可以通信，A和C不能通信。")]),a._v(" "),t("h2",{attrs:{id:"_2-nat模式-如果我们想让主机a能访问主机c-怎么办呢"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-nat模式-如果我们想让主机a能访问主机c-怎么办呢"}},[a._v("#")]),a._v(" 2. NAT模式：如果我们想让主机A能访问主机C，怎么办呢？")]),a._v(" "),t("h3",{attrs:{id:"_2-1-思路"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-思路"}},[a._v("#")]),a._v(" 2.1 思路")]),a._v(" "),t("ol",[t("li",[a._v("我们可以把B作为网关，在A上增加一个设置，告诉他，默认网关是B")]),a._v(" "),t("li",[a._v("在B上设置NAT转发")])]),a._v(" "),t("p",[a._v("从A(192.168.1.100)发往C(172.16.1.100)的数据包，首先查看A本地的路由表，查到默认网关是192.168.1.1，将数据包发给了192.168.1.1。\nB主机的192.168.1.1收到数据，将来源地址192.168.1.100修改成172.16.1.101再转发出去。")]),a._v(" "),t("h3",{attrs:{id:"_2-2-具体的步骤-linux环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-具体的步骤-linux环境"}},[a._v("#")]),a._v(" 2.2 具体的步骤（linux环境）")]),a._v(" "),t("p",[t("strong",[a._v("下命令都是需要root来执行，ubuntu需要sudo su - 到root权限")])]),a._v(" "),t("p",[a._v("第一步：在A服务器上执行下面命令：增加一个本地路由规则，访问172.16.1.0/24的请求，都发送到192.168.1.1（也就是网关）")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("ip")]),a._v(" route "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.16")]),a._v(".1.0/24 via "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.1\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("第二步：在B服务器上执行下面命令：开启IP转发，配置NAT转发规则")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 启用forward，否则不会转发ip数据包")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sysctl")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-w")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("net.ipv4.ip_forward")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 在防火墙iptables里增加一个nat规则，在POSTROUTING链上增加规则，将目的ip是172.16.1.0/24子网的数据包，将源ip都修改为 172.16.1.101，通过ens33网卡发送出去。")]),a._v("\niptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" nat "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-A")]),a._v(" POSTROUTING "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--dst")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.16")]),a._v(".1.0/24 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-o")]),a._v(" ens33 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" SNAT "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--to")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.16")]),a._v(".1.101\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br")])]),t("p",[a._v("这样，在A上ping 172.16.1.100就可以ping通了。")]),a._v(" "),t("h2",{attrs:{id:"_3-路由跳转"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-路由跳转"}},[a._v("#")]),a._v(" 3. 路由跳转：")]),a._v(" "),t("p",[a._v("在主机a上执行 ip route add 172.16.1.0/24 via 192.168.1.1")]),a._v(" "),t("p",[a._v("在主机c上执行 ip route add 192.168.1.0/24 via 172.16.1.101")]),a._v(" "),t("p",[a._v("主机b上执行 sysctl -w net.ipv4.ip_forward=1")]),a._v(" "),t("p",[a._v("然后a就能ping通c了，c也能ping通a了。")])])}),[],!1,null,null,null);t.default=e.exports}}]);